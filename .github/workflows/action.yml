name: "build and test"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: bazelbuild/setup-bazelisk@v1
    - run: bazel build --config=built-toolchain //... && bazel test --config=built-toolchain //...

  # TODO: deprecate by Jan 2025 https://bazel.build/release
  build-e2e-bazel-5:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: bazelbuild/setup-bazelisk@v1
    - run: cd e2e/bazel-5 && bazel build //...

  # TODO: rename to build once we move into bazel 7 as the default
  build-bazel-7:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: bazelbuild/setup-bazelisk@v1
    - run: export USE_BAZEL_VERSION=6.x && bazel build //... && bazel test //...
